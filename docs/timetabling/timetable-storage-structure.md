# Timetable Object Storage Structure Updates

## New Directory Structure

The timetable processing system now uses a more organized directory structure in object storage:

```
schools/
├── {schoolId}/
│   ├── {timetableId}/
│   │   ├── input/
│   │   │   └── {originalFileName}.fet
│   │   └── output/
│   │       ├── {generated_file_1}
│   │       ├── {generated_file_2}
│   │       ├── ...
│   │       └── {generated_file_n}
│   ├── {anotherTimetableId}/
│   │   ├── input/
│   │   └── output/
│   └── ...
```

## Changes Made

### 1. Directory Structure
- **Input Files**: Stored in `{schoolId}/{timetableId}/input/`
- **Output Files**: Stored in `{schoolId}/{timetableId}/output/`
- This provides clear separation and organization by timetable

### 2. Complete File Upload
- **No Filtering**: ALL files generated by `fet-cl` command are now uploaded
- **File Types**: Includes .fet, .html, .csv, .txt, and any other generated files
- **Content-Type Detection**: Automatic detection based on file extensions

### 3. Processing Changes
- **Removed**: Specific FET output processing during upload phase
- **Future**: Output processing should be handled as a separate step
- **Storage Only**: Focus on storing all raw generated files

## File Types Generated by FET

The `fet-cl` command typically generates:
- `.fet` - Main timetable output file (XML format)
- `.html` - Human-readable HTML timetable views
- `.csv` - CSV export files (if enabled)
- `.txt` - Various text reports and statistics
- Other specialized output files depending on configuration

## Usage Examples

### Accessing Input Files
```typescript
// Input file location
const inputPath = `${schoolId}/${timetableId}/input/${fileName}`;
const inputFile = await getFileFromStorage('schools', inputPath);
```

### Accessing Output Files
```typescript
// List all output files for a timetable
const outputFiles = await listFiles('schools', `${schoolId}/${timetableId}/output/`);

// Get specific output file
const outputPath = `${schoolId}/${timetableId}/output/timetable.fet`;
const outputFile = await getFileFromStorage('schools', outputPath);
```

### Processing Workflow
1. **Generation**: Create and store input file in temporary location
2. **Processing**: Move input to structured location, run FET, upload all outputs
3. **Analysis**: Retrieve specific output files for database processing
4. **Display**: Access HTML files for user viewing

## Benefits

### Organization
- Clear separation between input and output
- Easy to locate files for specific timetables
- Better organization for multiple timetable versions

### Completeness
- All generated files are preserved
- Nothing is lost in the processing pipeline
- Full audit trail of generation process

### Scalability
- Structure scales with number of schools and timetables
- Easy to implement retention policies
- Supports future features like versioning

## Implementation Details

### FET Command Parameters
The system now uses comprehensive FET parameters to generate all possible outputs:
```bash
fet-cl --inputfile="input.fet" --outputdir="output/" --htmllevel=7 --exportcsv=true
```

### Content Type Detection
Files are uploaded with appropriate MIME types:
- `.html` → `text/html`
- `.xml`, `.fet` → `application/xml`
- `.csv` → `text/csv`
- `.txt` → `text/plain`
- Others → `application/octet-stream`

### Error Handling
- Individual file upload failures don't stop the process
- Warnings logged for failed uploads
- Process continues with available files

## Future Enhancements

### File Processing Service
Create a separate service to process the uploaded output files:
```typescript
async function processTimetableOutputs(schoolId: string, timetableId: string) {
  const outputFiles = await listFiles('schools', `${schoolId}/${timetableId}/output/`);
  
  // Find and process .fet file
  const fetFile = outputFiles.find(f => f.endsWith('.fet'));
  if (fetFile) {
    const fetContent = await getFileFromStorage('schools', fetFile);
    const processedData = processFETOutput(fetContent.toString());
    await storeTimetableData(timetableId, processedData);
  }
}
```

### File Management API
Endpoints to manage timetable files:
- `GET /api/timetables/{id}/files` - List all files
- `GET /api/timetables/{id}/files/{type}` - Get files by type
- `DELETE /api/timetables/{id}/files` - Clean up old files

### Retention Policies
Automatic cleanup of old timetable files:
- Keep input files permanently
- Retain output files for configurable period
- Archive to long-term storage if needed